#cloud-config

# Upgrade on first boot
package_update: true
package_upgrade: true

# Add baseline packages
packages:
  - git

write_files:
  # Setup the reconciliation service (systemd)
  - path: /etc/systemd/system/reconcile.service
    permissions: '0644'
    content: |
      [Unit]
      Description=Run reconciliation script

      [Service]
      Type=oneshot
      ExecStart=/usr/local/bin/reconcile.sh

  - path: /etc/systemd/system/reconcile.timer
    permissions: '0644'
    content: |
      [Unit]
      Description=Timer for reconciliation script

      [Timer]
      OnBootSec=10
      OnUnitActiveSec=1min
      Persistent=true

      [Install]
      WantedBy=timers.target

  - path: /usr/local/bin/reconcile.sh
    permissions: '0755'
    # Embedding scripts through templating is a bit hacky, but required for correct rendering.
    content: |
      #!/bin/bash
      # This is a **TEMPLATE** for a script that is used to reconcile the gitops repository and pull the latest changes.
      # Terraform replaces variables here with the actual values.
      
      # It is straightforward with no error handling, optimizations or hardening.
      # Use it as a reference and take into consideration the following (feel free to use LLMs to help you):
      # - Who is running this script.
      # - Where are application logs written.
      # - Where are application data written.
      # - Where are application secrets written.
      # - What if there's no changes in since last check?
      # - What if the repository is private?
      # - What if the container fails to start?
      
      # Standard bash error handling
      set -euo pipefail
      
      # Global variables
      REPOSITORY_DIRECTORY="/srv/gitops/repo"
      COMPOSE_FILE="$REPOSITORY_DIRECTORY/compose.yaml"
      
      
      # Check if the repository directory exists
      if [ ! -d "$REPOSITORY_DIRECTORY/.git" ]; then
          # Clone the repository
          echo "[INFO] Initial clone of repo..."
          git clone --branch "main" "https://github.com/LarsGJobloop/nix-devcontainer-example.git" "$REPOSITORY_DIRECTORY"
      else
          # Update the existing repository
          echo "[INFO] Updating existing repo..."
          git -C "$REPOSITORY_DIRECTORY" pull
      fi
      
      # Pull the latest changes
      docker compose --file "$COMPOSE_FILE" pull
      
      # Replace the existing container with the new one, removing any orphaned containers
      docker compose --file "$COMPOSE_FILE" up --detach --remove-orphans
      
      # Log the end of the script
      echo "[INFO] Reconciliation complete"

runcmd:
  # Add Docker's official identity (GPG key)
  - install -m 0755 -d /etc/apt/keyrings
  - curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
  - chmod a+r /etc/apt/keyrings/docker.gpg

  # Add Docker's official repository
  - |
    echo \
      "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
      https://download.docker.com/linux/debian \
      $(lsb_release -cs) stable" \
      > /etc/apt/sources.list.d/docker.list

  # Update package index and install Docker components
  - apt-get update
  # - apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

  # Ensure docker is running
  - systemctl enable docker
  - systemctl start docker

  # Create GitOps repo dir
  - mkdir -p /srv/gitops

  # Setup the reconciliation service
  - chmod +x /usr/local/bin/reconcile.sh
  - systemctl daemon-reload
  - systemctl enable reconcile.timer
  - systemctl start reconcile.timer
